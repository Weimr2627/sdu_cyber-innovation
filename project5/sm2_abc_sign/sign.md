# sm2数字签名伪造技术

## 1. 数字签名伪造


### 1.1 椭圆曲线数字签名的数学结构

SM2签名算法基于椭圆曲线离散对数问题（ECDLP）的困难性假设。设E为定义在有限域F_p上的椭圆曲线，P为E上的基点，其阶为素数n。ECDLP问题描述为：

给定椭圆曲线点P和Q = dP，计算整数d。

SM2签名的数学结构可表示为映射：
```
Σ: M × Z_n → Z_n × Z_n
(m, k) ↦ (r, s)
```

其中：
```
r = (e + x₁) mod n, (x₁, y₁) = kP
s = (1 + d)⁻¹(k - rd) mod n
e = H(Z_A || m)
```

## 2. 存在性伪造的可能性分析

### 2.1 基于随机预言机模型的分析

在随机预言机模型下，哈希函数H被视为真随机函数。攻击者尝试存在性伪造的策略是：随机选择r, s ∈ Z_n，计算对应的椭圆曲线点，然后寻找使得验证等式成立的消息。

设攻击者选择(r, s)，计算：
```
t = (r + s) mod n
(x', y') = sP + tQ
```

为使伪造成功，需要找到消息m使得：
```
H(Z_A || m) = (r - x') mod n
```

由于H为随机函数，对于固定的(r - x') mod n，满足条件的m存在的概率为1/n。因此，攻击者需要平均尝试n次才能找到合适的消息，时间复杂度为O(n)。

### 2.2 哈希函数抗原像攻击能力的影响

在实际应用中，哈希函数H通常为SHA-256或SM3，具有2^256的抗原像攻击安全强度。攻击者需要解决的问题等价于：

给定target = (r - x') mod n，找到m使得H(Z_A || m) ≡ target (mod n)。

这本质上是一个哈希原像问题。由于|target| = 256位而n ≈ 2^256，攻击者需要平均尝试2^255次哈希运算才能找到合适的m。

### 2.3 生日攻击在存在性伪造中的应用

攻击者可采用生日攻击的思想降低存在性伪造的复杂度：

1. 生成2^128个不同的消息{m₁, m₂, ..., m_{2^128}}，计算对应的哈希值
2. 生成2^128个不同的(r, s)对，计算对应的(r - x')值
3. 寻找碰撞：H(Z_A || mᵢ) = (rⱼ - x'ⱼ) mod n

根据生日悖论，当样本数量达到√n ≈ 2^128时，找到碰撞的概率约为50%。然而，这种攻击需要2^128的存储空间和时间复杂度，在实际中仍然不可行。

## 3. 基于椭圆曲线结构的伪造技术

### 3.1 无效曲线攻击的数学原理

无效曲线攻击利用了椭圆曲线参数验证不足的漏洞。攻击者构造一个与标准曲线不同但具有相似性质的"无效曲线"，使得在该曲线上进行的运算结果能够通过标准曲线的验证。

设标准SM2曲线为：
```
E: y² = x³ + ax + b (mod p)
```

攻击者构造无效曲线：
```
E': y² = x³ + ax + b' (mod p)
```

其中b' ≠ b。如果实现没有验证公钥点是否在标准曲线上，攻击者可以在E'上选择一个低阶点P'，使得nP' = O，从而简化离散对数问题。

### 3.2 小子群攻击的代数分析

椭圆曲线的点群结构为E(F_p) ≅ Z_{n₁} × Z_{n₂}，其中n₁n₂ = |E(F_p)|。如果椭圆曲线的阶包含小因子，攻击者可以利用中国剩余定理将离散对数问题分解为较小子群上的问题。

设椭圆曲线的阶为N = ∏pᵢᵃⁱ，其中pᵢ为小素数。攻击者可以在每个子群中独立求解离散对数，然后使用CRT重构完整解。

对于子群Zpᵢᵃⁱ，离散对数问题的复杂度降为O(√pᵢᵃⁱ)。如果所有pᵢ都较小，总体攻击复杂度将显著降低。

### 3.3 异常椭圆曲线的利用

异常椭圆曲线是指阶等于有限域大小的椭圆曲线，即|E(F_p)| = p。在这种曲线上，椭圆曲线离散对数问题可以归约到有限域上的离散对数问题，后者可以通过指数演算等方法高效求解。

对于异常椭圆曲线E/F_p，存在同构映射φ: E(F_p) → (F_p, +)，使得椭圆曲线加法运算对应于有限域加法。这种映射被称为"异常映射"或"Smart攻击"。

## 4. 实现级漏洞的数学建模

### 4.1 模运算实现的侧信道分析

椭圆曲线标量乘法k·P的实现通常采用二进制方法：

```
Algorithm BinaryMethod(k, P):
    Q = O
    for i = log₂(k) down to 0:
        Q = 2Q
        if bit(k, i) = 1:
            Q = Q + P
    return Q
```

该算法的执行时间取决于k的汉明权重。设k的二进制表示为k = ∑kᵢ2ⁱ，则算法执行时间为：

```
T(k) = t_double × log₂(k) + t_add × HW(k) + noise
```

其中HW(k)为k的汉明权重，noise为随机噪声。

攻击者通过测量多次签名操作的时间，可以建立关于私钥d的信息。具体而言，对于签名中的随机数kᵢ，其与私钥d的乘积kᵢd的汉明权重与执行时间存在线性相关性。

### 4.2 功耗分析攻击的信号处理模型

在椭圆曲线标量乘法过程中，设备的功耗信号包含了运算数据的信息。功耗信号可建模为：

```
P(t) = α·HW(data(t)) + β + ε(t)
```

其中α为功耗系数，data(t)为t时刻处理的数据，β为基础功耗，ε(t)为噪声。

攻击者通过收集大量功耗轨迹，使用相关功耗分析（CPA）技术恢复密钥信息。设猜测密钥为k_guess，中间值为V = f(plaintext, k_guess)，则相关系数为：

```
ρ = Σ(Pᵢ - P̄)(HW(Vᵢ) - HW(V̄)) / √(Σ(Pᵢ - P̄)²Σ(HW(Vᵢ) - HW(V̄))²)
```

当k_guess等于真实密钥时，ρ达到最大值。

### 4.3 错误注入攻击的代数结构

错误注入攻击通过在密码运算过程中引入故意的错误，利用正确结果和错误结果之间的差异来恢复密钥信息。在椭圆曲线签名中，最常见的是针对标量乘法运算的错误注入。

设正常的标量乘法结果为R = kP，在第j位发生错误后，结果变为R' = (k ⊕ 2^j)P。攻击者通过比较正常签名和错误签名，可以确定错误发生的位置，进而推断出k的相关信息。

数学上，错误注入攻击利用了椭圆曲线群运算的线性性质：

```
R' - R = (k ⊕ 2^j)P - kP = ±2^j P
```

通过椭圆曲线点的加法规则，攻击者可以验证猜测的错误位置是否正确。

<img width="932" height="258" alt="image" src="https://github.com/user-attachments/assets/951dc4df-9d2c-47ce-b2a3-fdb3e52f7200" />







