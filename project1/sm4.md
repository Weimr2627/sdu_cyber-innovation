# SM4 加密算法原理

## 1. 加密过程概述
<img width="409" alt="image" src="https://github.com/user-attachments/assets/7ce726b7-4185-4a33-aea5-97929eb55424" /><br>  
### 输入格式
输入 128-bit 明文 `M`，按 32-bit 划分为：(X0₀, X1₀, X2₀, X3₀)
### 加密迭代过程
进行 **32 轮迭代**，每轮使用一个 32-bit 的轮密钥 `Kᵢ`。第 `i` 轮的迭代规则如下：<br>
X0ᵢ = X1ᵢ₋₁<br>
X1ᵢ = X2ᵢ₋₁<br>
X2ᵢ = X3ᵢ₋₁<br>
X3ᵢ = X0ᵢ₋₁ ⊕ T(X1ᵢ₋₁ ⊕ X2ᵢ₋₁ ⊕ X3ᵢ₋₁ ⊕ Kᵢ₋₁)<br>
最终，输出 128-bit 密文 `C` 为第 32 轮的输出逆序排列：<br>
C = (Y0, Y1, Y2, Y3) = (X3₃₂, X2₃₂, X1₃₂, X0₃₂)
## 2. 轮函数 T 的定义
函数 `T` 是非线性变换 `S` 和线性变换 `L` 的复合：<br>
T = L ∘ S
### 输入格式
输入 32-bit 的 `A = (a0, a1, a2, a3)`，其中每个 `aᵢ ∈ F₂⁸`
#### 非线性变换 S

每个字节单独查表替换（S-Box）：
B = S(A) = (S(a0), S(a1), S(a2), S(a3))
查表方法：高 4 位作为行索引，低 4 位作为列索引。例如：
S(0x07) = 0xB7
<img width="819" alt="image" src="https://github.com/user-attachments/assets/309369b1-b44b-4beb-a791-f687f11f1640" />
#### 线性变换 L
对 `S` 的输出 `B` 执行如下变换：
L(B) = B ⊕ (B <<< 2) ⊕ (B <<< 10) ⊕ (B <<< 18) ⊕ (B <<< 24)
## 3. 轮密钥生成算法

### 初始主密钥

主密钥 `K = MK0 || MK1 || MK2 || MK3`，每段 32 位。

与系统参数 FK 异或，得：
K₋₄ = MK0 ⊕ FK0
K₋₃ = MK1 ⊕ FK1
K₋₂ = MK2 ⊕ FK2
K₋₁ = MK3 ⊕ FK3


系统参数 FK：

FK0 = 0xA3B1BAC6
FK1 = 0x56AA3350
FK2 = 0x677D9197
FK3 = 0xB27022DC


### 轮密钥 Ki (i = 0,...,31)

Ki = Ki₋₄ ⊕ T′(Ki₋₃ ⊕ Ki₋₂ ⊕ Ki₋₁ ⊕ CKi)


#### T′函数定义：

T′ = L′ ∘ S



其中线性变换 L′ 为：

L′(B) = B ⊕ (B <<< 13) ⊕ (B <<< 23)

shell
复制
编辑

### 固定参数 CKi (i = 0,...,31)

示例（前几项）：

CK0 = 0x00070E15
CK1 = 0x1C232A31
CK2 = 0x383F464D
...
CK31 = 0x2C333A41



完整 CK 列表可参考 SM4 标准。

---

## 4. 解密算法

由于 SM4 是基于广义 Feistel 网络设计的，加密与解密结构完全相同，只需反向使用密钥：

解密第 i 轮使用的密钥为：K₃₂₋ᵢ

yaml
复制
编辑

---

## 5. 小结

- SM4 是中国国家商用密码算法之一
- 使用 128-bit 密钥，128-bit 明文分组
- 总共 32 轮迭代，每轮用 32-bit 密钥
- 使用单一 S 盒 + 特殊线性变换构造轮函数
- 解密过程与加密过程完全一致

---
